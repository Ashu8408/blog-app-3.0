<%= turbo_frame_tag "turbo-content" do %>
  <div data-controller="posts">
    <% content_for :page_title, "Welcome to Blog App" %>
   
    <div class="container mx-auto py-2">
      <div class="flex gap-5 mb-4 p-2 bg-gray-200">
        <input type="text" id="searchInput" placeholder="Search posts..." class="w-1/3 bg-white placeholder:text-slate-400 text-slate-700 text-sm border border-slate-200 rounded-md pl-3 pr-28 px-3 py-2 transition duration-300 ease focus:outline-none focus:border-slate-400 hover:border-slate-300 shadow-sm focus:shadow">
        <p id="searchResultsPosts" class="whitespace-nowrap mt-2"></p>
      </div>
      
      <div id="post_container" class="p-2">
        <%= render partial: "posts/posts", locals: { posts: @posts } %>
      </div>
      <div class="flex justify-center gap-2 items-center mt-4">
        <button id="post_prev_page" class="flex items-center px-2 py-1 bg-gray-300 rounded">
          <svg class="w-3.5 h-3.5 me-2 rtl:rotate-180" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 10">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5H1m0 0 4 4M1 5l4-4"/>
          </svg>
          Previous
        </button>
        <div id="post_page_numbers" class="flex gap-2"></div>
        <button id="post_next_page" class="flex items-center px-2 py-1 bg-gray-300 rounded">
          Next
          <svg class="w-3.5 h-3.5 ms-2 rtl:rotate-180" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 10">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 5h12m0 0L9 1m4 4L9 9"/>
          </svg>
        </button>
      </div>
      <p id="post_page_info" class="text-center mt-2"></p>
    </div>
  </div>

  <div class="p-5">
    <div class="mb-4 flex flex-wrap gap-4">
      <input type="text" id="search_title" placeholder="Search by Title" class="border p-2 rounded w-1/4">
      <input type="text" id="search_created_by" placeholder="Search by Created By" class="border p-2 rounded w-1/4">
      <input type="number" id="min_content_length" placeholder="Min Content Length" class="border p-2 rounded w-1/4">
      <input type="number" id="max_content_length" placeholder="Max Content Length" class="border p-2 rounded w-1/4">
      <button id="apply_filters" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-700">Apply Filters</button>
    </div>
    <table id="posts_table" class="min-w-full border border-gray-300 bg-white shadow-lg">
      <thead>
        <tr class="bg-gray-200">
          <th class="px-4 py-2 border">#</th>
          <th class="px-4 py-2 border">Title</th>
          <th class="px-4 py-2 border">Content Length</th>
          <th class="px-4 py-2 border">Comments Count</th>
          <th class="px-4 py-2 border">Created By</th>
          <th class="px-4 py-2 border">Actions</th>
        </tr>
      </thead>
      <tbody id="posts_table_body">
        <% @posts.each_with_index do |post, index| %>
          <tr class="post_row text-center">
            <td class="px-4 py-2 border index-column"><%= index + 1 %></td>
            <td class="px-4 py-2 border post-title">
              <%= link_to post_path(post), data: { turbo_frame: "post_details", turbo_action: "advance" }, class: 'block w-full py-2' do %>
                <%= post.title %>
              <% end %>
            </td>
            <td class="px-4 py-2 border post-content-length"><%= post.content.length %></td>
            <td class="px-4 py-2 border"><%= post.comments.count %></td>
            <td class="px-4 py-2 border post-created-by"><%= post.user&.email.presence || "N/A" %></td>
            <td class="px-4 py-2 border"> 
              <%= link_to 'View', post_path(post), class: "bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-700" %>
              <% if post.user == current_user %>
                <%= link_to 'Edit', edit_post_path(post), class: "bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-700" %>
                <%= link_to 'Delete', post_path(post), method: :delete, data: { confirm: 'Are you sure?' }, class: "bg-red-500 text-white px-3 py-1 rounded hover:bg-red-700" %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>

    </table>
    <!-- Pagination Controls -->
    <div class="flex justify-between items-center mt-4">
      <button id="prev_page" class="bg-gray-500 text-white px-4 py-2 rounded invisible">Previous</button>
      <span id="page_info" class="text-gray-700"></span>
      <button id="next_page" class="bg-gray-500 text-white px-4 py-2 rounded">Next</button>
    </div>
    <div id="page_numbers" class="flex justify-center mt-2"></div>
  </div>
<% end %>


<script>
document.getElementById("apply_filters").addEventListener("click", function() {
    const titleQuery = document.getElementById("search_title").value.toLowerCase().trim();
    const createdByQuery = document.getElementById("search_created_by").value.toLowerCase().trim();
    const minContentLength = parseInt(document.getElementById("min_content_length").value) || 0;
    const maxContentLength = parseInt(document.getElementById("max_content_length").value) || Infinity;

    document.querySelectorAll(".post_row").forEach(row => {
        const postTitleElem = row.querySelector(".post-title");
        const postCreatedByElem = row.querySelector(".post-created-by");
        const postContentLengthElem = row.querySelector(".post-content-length");

        if (!postTitleElem || !postCreatedByElem || !postContentLengthElem) {
          console.warn("Missing post element in row:", row);
          return;
        }

        const postTitle = postTitleElem.innerText.toLowerCase();
        const postCreatedBy = postCreatedByElem.innerText.toLowerCase();
        const postContentLength = parseInt(postContentLengthElem.innerText);

        const matchesTitle = !titleQuery || postTitle.includes(titleQuery);
        const matchesCreatedBy = !createdByQuery || postCreatedBy.includes(createdByQuery);
        const matchesContentLength = postContentLength >= minContentLength && postContentLength <= maxContentLength;

        row.style.display = (matchesTitle && matchesCreatedBy && matchesContentLength) ? "table-row" : "none";
    });
});

</script>